#!/bin/sh

# make sure the exposed port is passed as an argument
# we need that one for the IPython notebook base_url
if [ $# -ne 1 ]; then
    exit 65
fi

PORT=$1
# get the user to which this container belongs
# since we only mount the owner's home directory and no one is able to create dirs in /home
# we can be sure there is only one dir with the username's name
USER=`ls /home/`

# set the user as an allowed SSH user
sed -i "s/#\?AllowUsers.*/AllowUsers ${USER}/" /etc/ssh/sshd_config

# chown all python modules to the current user
# cloned containers may otherwise contain files by other users so we wouldn't have permissions
chown -R ${USER} /usr/local/lib/python3.4/dist-packages/

# create the symlink home symlink
# this is a temporary fix, since docker-py has problems mounting the same dir twice
if [ -h /data/home ]; then
    unlink /data/home
fi
# TODO: causes recursion /data/home/$USER/$USER/...
ln -s /home/${USER} /data/home

# chown the /data directory so the user is able to store his personal per-container
# files in there
chown ${USER}:${USER} /data

# create the IPython profile
# we need it before we start so we can set the base_url
/sbin/setuser ${USER} \
    ipython profile create default --ipython-dir=/data/.ipython
sed -i 's/c.NotebookApp/#c.NotebookApp/' /data/.ipython/profile_default/ipython_notebook_config.py
echo "c.NotebookApp.base_url = '/workspace/49154/'" >> /data/.ipython/profile_default/ipython_notebook_config.py
sed -i "s/# #c.NotebookApp.allow_origin = ''/c.NotebookApp.allow_origin = '*'/" /data/.ipython/profile_default/ipython_notebook_config.py

# start the IPython notebook server
/sbin/setuser ${USER} \
    ipython3 notebook --no-browser --ip=0.0.0.0 \
    --ipython-dir=/data/.ipython --notebook-dir=/data --user=${USER}
